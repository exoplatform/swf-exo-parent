name: Update Submodules
on:
  schedule:
    - cron:  '* 4 * * *' # Everyday at 4 AM UTC
  workflow_dispatch:

jobs:

  update-submodules:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Install SSH key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_KEY }}
        known_hosts: ${{ secrets.KNOWN_HOSTS }}
    - name: Fetch Submodules
      run: |
        scripts/clone_all_submodules.sh || :
      env:
        GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
    # Update references
    - name: Git Sumbodule Update
      run: |
        git pull --recurse-submodules
        git submodule update --remote --recursive

    - name: Pull Submodules
      run: |
        git submodule sync
        git submodule update
        git submodule foreach "git checkout develop 2>/dev/null || git checkout master; git pull || :"
  
    - name: Commit update
      run: |
        git config --global user.name 'eXo Software Factory'
        git config --global user.email 'exo-swf@exoplatform.com'
        git commit -am "Auto updated submodule references $(date +%d-%m-%Y)" && git push || echo "No changes to commit"
